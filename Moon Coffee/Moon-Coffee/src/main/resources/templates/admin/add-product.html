<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Qu√°n C√† Ph√™</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { display: flex; min-height: 100vh; background-color: #f4f6f9; }

        /* Sidebar */
        .sidebar { width: 260px; background-color: #2d3436; color: #fff; padding: 20px; display: flex; flex-direction: column; }
        .logo { font-size: 22px; font-weight: bold; margin-bottom: 30px; text-align: center; color: #fab1a0; }
        .btn-menu-add { background: linear-gradient(135deg, #e17055 0%, #d63031 100%); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 30px; display: flex; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-menu-add:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(214, 48, 49, 0.4); }
        .menu-list { list-style: none; }
        .menu-item { padding: 12px; margin-bottom: 5px; cursor: pointer; color: #b2bec3; border-radius: 6px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }
        a { text-decoration: none; color: inherit; }

        /* Main Content */
        .main-content { flex: 1; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 15px; background-color: #f8f9fa; color: #666; border-bottom: 2px solid #ddd; }
        td { padding: 15px; border-bottom: 1px solid #eee; color: #333; vertical-align: middle; }
        tr:hover { background-color: #f1f1f1; }
        .table-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; padding: 30px; border-radius: 15px; width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 8px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: #eee; }
        .btn-save { background: #e17055; color: white; }
    </style>
</head>
<body>

<nav class="sidebar">
    <div class="logo"><a href="/">‚òï MOON COFFEE</a></div>
    <button class="btn-menu-add" onclick="toggleModal()"><span>+</span> Th√™m M√≥n M·ªõi</button>

    <ul class="menu-list">
        <li class="menu-item" style="background: rgba(255,255,255,0.1); margin-bottom: 15px;">
            <a href="/" style="display: flex; align-items: center; gap: 10px; color: #fab1a0; font-weight: bold;">
                <span>üè†</span> V·ªÅ Trang Ch·ªß
            </a>
        </li>
        <li class="menu-item active">Danh s√°ch ƒë·ªì u·ªëng</li>
        <li class="menu-item">Doanh thu</li>
        <li class="menu-item">C√†i ƒë·∫∑t</li>

        <li class="menu-item" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <a href="/logout" style="color: #ff7675;">üö™ ƒêƒÉng Xu·∫•t</a>
        </li>
    </ul>
</nav>

<main class="main-content">
    <div class="card">
        <h1>Qu·∫£n L√Ω S·∫£n Ph·∫©m (Admin)</h1>

        <table>
            <thead>
            <tr>
                <th>STT</th>
                <th>·∫¢nh</th>
                <th>T√™n m√≥n</th>
                <th>Danh m·ª•c</th>
                <th>Gi√° b√°n</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody id="productTableBody">
            <tr th:each="product, iterStat : ${products}">
                <td th:text="${iterStat.count}">1</td>

                <td>
                    <img th:if="${product.imageName != null}"
                         th:src="@{'/images/products/' + ${product.imageName}}"
                         class="table-img">
                    <span th:if="${product.imageName == null}" style="color: #ccc; font-size: 12px;">Ch∆∞a c√≥ ·∫£nh</span>
                </td>

                <td th:text="${product.name}">T√™n m√≥n</td>

                <td th:text="${product.category != null ? product.category.name : 'Ch∆∞a ph√¢n lo·∫°i'}"
                    style="color: #666; font-style: italic;">
                    Danh m·ª•c
                </td>

                <td th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'POINT')} + ' ƒë'">0 ƒë</td>

                <td>
                    <a href="javascript:void(0)"
                       style="color:red; cursor: pointer; font-weight: bold; text-decoration: none;"
                       th:onclick="'deleteProduct(' + ${product.id} + ')'">
                        X√≥a
                    </a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

<div class="modal-overlay" id="addModal">
    <div class="modal-box">
        <h2>Th√™m M√≥n M·ªõi</h2>
        <form id="addForm">
            <div class="form-group">
                <label>T√™n m√≥n (*)</label>
                <input type="text" id="inputName" required>
            </div>

            <div class="form-group">
                <label>Danh m·ª•c</label>
                <select id="inputCategory">
                    <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
                </select>
            </div>

            <div class="form-group">
                <label>Gi√° ti·ªÅn (*)</label>
                <input type="number" id="inputPrice" required>
            </div>

            <div class="form-group" style="border-top: 1px dashed #ddd; padding-top: 15px; margin-top: 15px;">
                <label>H√¨nh ·∫£nh (T√πy ch·ªçn)</label>
                <input type="file" id="inputImage" accept="image/png, image/jpeg, image/jpg">
                <small style="color: #888;">Ch·∫•p nh·∫≠n file .jpg, .png</small>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="toggleModal()">H·ªßy</button>
                <button type="button" class="btn btn-save" onclick="addProduct()">L∆∞u L·∫°i</button>
            </div>
        </form>
    </div>
</div>

<script>
    // H√†m ƒë√≥ng m·ªü modal
    function toggleModal() {
        document.getElementById('addModal').classList.toggle('active');
    }

    // 1. H√ÄM TH√äM S·∫¢N PH·∫®M (C√≥ upload ·∫£nh)
    function addProduct() {
        var nameVal = document.getElementById("inputName").value;
        var priceVal = document.getElementById("inputPrice").value;
        var catIdVal = document.getElementById("inputCategory").value;
        var imageFile = document.getElementById("inputImage").files[0];

        if(nameVal == "" || priceVal == "") {
            alert("Vui l√≤ng nh·∫≠p t√™n v√† gi√°!");
            return;
        }

        var formData = new FormData();
        formData.append("name", nameVal);
        formData.append("price", priceVal);
        formData.append("categoryId", catIdVal);
        if (imageFile) {
            formData.append("imageFile", imageFile);
        }

        fetch('/api/products/save', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
                location.reload();
            } else {
                response.text().then(text => alert("L·ªói: " + text));
            }
        })
        .catch(error => {
            console.error('L·ªói:', error);
            alert("L·ªói k·∫øt n·ªëi server.");
        });
    }

    // 2. H√ÄM X√ìA S·∫¢N PH·∫®M
    function deleteProduct(id) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y kh√¥ng?')) {
            fetch('/api/products/delete/' + id, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert("ƒê√£ x√≥a th√†nh c√¥ng!");
                    location.reload();
                } else {
                    alert("C√≥ l·ªói x·∫£y ra khi x√≥a!");
                }
            })
            .catch(error => {
                console.error('L·ªói:', error);
                alert("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi server.");
            });
        }
    }

    // ƒê√≥ng modal khi click ra ngo√†i
    document.getElementById('addModal').addEventListener('click', function(e) {
        if (e.target === this) toggleModal();
    });
</script>

</body>
</html>